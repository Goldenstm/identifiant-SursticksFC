<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Stickers - Application</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1b3a;
            --bg-tertiary: #252650;
            --text-primary: #ffffff;
            --text-secondary: #a0a0c8;
            --text-muted: #6b6b8c;
            --border: #2d2e5c;
            --border-light: #383866;
            --shadow: rgba(0, 0, 0, 0.4);
            --accent: #667eea;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 16px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .page {
            display: none;
            min-height: 100vh;
            padding: 24px;
        }

        .page.active {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Page 1 - Carte */
        .map-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .map-header h1 {
            font-size: clamp(2rem, 4vw, 3rem);
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .map-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .map-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px var(--shadow);
            overflow: hidden;
            height: 70vh;
            min-height: 500px;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            cursor: crosshair;
        }

        .map-instructions {
            position: absolute;
            top: 16px;
            left: 16px;
            background: rgba(26, 27, 58, 0.95);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            box-shadow: 0 10px 15px -3px var(--shadow);
            max-width: 300px;
            z-index: 1000;
        }

        .map-instructions h3 {
            color: var(--accent);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .map-instructions p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Page 2 - Photo */
        .photo-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .photo-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            padding: 40px;
            box-shadow: 0 20px 25px -5px var(--shadow);
            max-width: 500px;
            width: 100%;
        }

        .camera-frame {
            width: 300px;
            height: 400px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            border: 3px solid var(--border-light);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 32px;
            position: relative;
            overflow: hidden;
        }

        .camera-icon {
            font-size: 4rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: calc(var(--radius) - 3px);
        }

        .video-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: calc(var(--radius) - 3px);
        }

        .photo-buttons {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
        }

        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #5a6fd8);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--border-light);
        }

        .file-input {
            display: none;
        }

        /* Page 3 - Confirmation */
        .confirmation-page {
            max-width: 1000px;
            margin: 0 auto;
        }

        .confirmation-layout {
            display: grid;
            grid-template-columns: 40% 60%;
            gap: 32px;
            margin-bottom: 32px;
        }

        .image-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .confirmation-image {
            max-width: 100%;
            max-height: 350px;
            border-radius: var(--radius-sm);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            object-fit: cover;
        }

        .form-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input[readonly] {
            background: var(--bg-primary);
            color: var(--text-muted);
        }

        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: flex-end;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        /* Bouton continuer */
        .btn-continue {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn-continue:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        /* Stickers sur la carte */
        .sticker-marker {
            background: var(--accent);
            border: 2px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        /* Loading et messages */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 500;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            opacity: 0;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .confirmation-layout {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .camera-frame {
                width: 250px;
                height: 350px;
            }

            .photo-buttons {
                flex-direction: column;
            }

            .form-actions {
                flex-direction: column;
            }

            .page {
                padding: 16px;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page.active {
            animation: fadeIn 0.6s ease-out;
        }
    </style>
</head>
<body>
    <!-- Page 1 - Carte -->
    <div id="page1" class="page active">
        <div class="container">
            <div class="map-header">
                <h1>‚öΩ Football Stickers</h1>
                <p>Cliquez sur la carte pour poser un sticker !</p>
            </div>

            <div class="map-container">
                <div class="map-instructions">
                    <h3>üìç Instructions</h3>
                    <p>Cliquez n'importe o√π sur la carte pour commencer √† poser un sticker √† cet endroit.</p>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Page 2 - Photo -->
    <div id="page2" class="page">
        <div class="container photo-page">
            <h1 style="margin-bottom: 32px;">üì∑ Prendre une photo</h1>
            
            <div class="photo-container">
                <div class="camera-frame">
                    <div id="cameraPlaceholder">
                        <div class="camera-icon">üì∑</div>
                        <p style="color: var(--text-muted);">Prenez ou choisissez une photo</p>
                    </div>
                    <video id="videoPreview" class="video-preview" autoplay playsinline style="display: none;"></video>
                    <img id="imagePreview" class="preview-image" style="display: none;" />
                </div>

                <div class="photo-buttons">
                    <button id="takePictureBtn" class="btn btn-primary">
                        üì∏ Prendre une photo
                    </button>
                    
                    <button id="captureBtn" class="btn btn-success" style="display: none;">
                        ‚úÖ Capturer
                    </button>

                    <label for="fileInput" class="btn btn-secondary">
                        üñºÔ∏è Choisir depuis galerie
                    </label>
                    <input type="file" id="fileInput" class="file-input" accept="image/*">

                    <button id="retakeBtn" class="btn btn-secondary" style="display: none;">
                        üîÑ Reprendre
                    </button>

                    <button id="continueBtn" class="btn btn-continue" style="display: none;">
                        ‚û°Ô∏è Continuer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page 3 - Confirmation -->
    <div id="page3" class="page">
        <div class="container">
            <div class="confirmation-page">
                <h1 style="margin-bottom: 32px; text-align: center;">‚úÖ Confirmer le sticker</h1>

                <div class="confirmation-layout">
                    <div class="image-section">
                        <img id="finalImage" class="confirmation-image" />
                    </div>

                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label" for="clubInput">Club * (obligatoire)</label>
                            <select id="clubInput" class="form-select" required>
                                <option value="">Choisir un club</option>
                                <option value="PSG">Paris Saint-Germain</option>
                                <option value="Lyon">Olympique Lyonnais</option>
                                <option value="OM">Olympique de Marseille</option>
                                <option value="Monaco">AS Monaco</option>
                                <option value="Lille">Lille OSC</option>
                                <option value="Rennes">Stade Rennais</option>
                                <option value="Nice">OGC Nice</option>
                                <option value="Strasbourg">RC Strasbourg</option>
                                <option value="Nantes">FC Nantes</option>
                                <option value="Bordeaux">FC Girondins de Bordeaux</option>
                                <option value="Lens">RC Lens</option>
                                <option value="Saint-Etienne">AS Saint-√âtienne</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="timeInput">Heure</label>
                            <input type="text" id="timeInput" class="form-input" readonly>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="locationInput">Coordonn√©es GPS</label>
                            <input type="text" id="locationInput" class="form-input">
                        </div>

                        <div class="form-actions">
                            <button id="deleteBtn" class="btn btn-danger">
                                üóëÔ∏è Supprimer
                            </button>
                            <button id="saveBtn" class="btn btn-success">
                                üíæ Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        class StickerApp {
            constructor() {
                this.currentPage = 1;
                this.selectedCoords = null;
                this.capturedImage = null;
                this.map = null;
                this.stickers = this.loadStickersFromStorage();
                this.stream = null;
                
                this.init();
            }

            // M√©thode pour charger les stickers depuis le localStorage avec gestion d'erreur
            loadStickersFromStorage() {
                try {
                    const stored = localStorage.getItem('stickers');
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error('Erreur lors du chargement des stickers:', error);
                    return [];
                }
            }

            // M√©thode pour sauvegarder les stickers avec gestion d'erreur am√©lior√©e
            saveStickersToStorage() {
                try {
                    const dataToSave = JSON.stringify(this.stickers);
                    
                    // V√©rifier la taille des donn√©es (approximative)
                    const sizeInMB = new Blob([dataToSave]).size / 1024 / 1024;
                    console.log(`Taille des donn√©es √† sauvegarder: ${sizeInMB.toFixed(2)} MB`);
                    
                    if (sizeInMB > 4) {
                        this.showNotification('Trop de stickers sauvegard√©s. Supprimez-en quelques-uns.', 'error');
                        return false;
                    }
                    
                    localStorage.setItem('stickers', dataToSave);
                    return true;
                } catch (error) {
                    console.error('Erreur lors de la sauvegarde:', error);
                    
                    if (error.name === 'QuotaExceededError') {
                        this.showNotification('Espace de stockage insuffisant. Image trop volumineuse.', 'error');
                    } else {
                        this.showNotification('Erreur de sauvegarde: ' + error.message, 'error');
                    }
                    return false;
                }
            }

            init() {
                this.initMap();
                this.loadStickers();
                this.setupEventListeners();
                this.requestPermissions();
            }

            // Gestion des pages
            showPage(pageNumber) {
                // Masquer toutes les pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // Afficher la page demand√©e
                document.getElementById(`page${pageNumber}`).classList.add('active');
                this.currentPage = pageNumber;

                // Actions sp√©cifiques par page
                if (pageNumber === 1) {
                    this.stopCamera();
                    setTimeout(() => {
                        if (this.map) {
                            this.map.invalidateSize();
                        }
                    }, 100);
                } else if (pageNumber === 2) {
                    this.resetPhotoPage();
                } else if (pageNumber === 3) {
                    this.setupConfirmationPage();
                }
            }

            // Page 1 - Carte
            initMap() {
                this.map = L.map('map').setView([46.603354, 1.888334], 6);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                // G√©olocalisation
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        this.map.setView([lat, lng], 12);
                    }, (error) => {
                        console.log('G√©olocalisation non disponible:', error);
                    });
                }

                // Clic sur la carte
                this.map.on('click', (e) => {
                    this.selectedCoords = {
                        lat: e.latlng.lat,
                        lng: e.latlng.lng
                    };
                    this.showPage(2);
                });
            }

            loadStickers() {
                this.stickers.forEach(sticker => {
                    try {
                        const marker = L.marker([sticker.lat, sticker.lng])
                            .addTo(this.map)
                            .bindPopup(`
                                <div style="text-align: center;">
                                    <img src="${sticker.image}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                                    <div><strong>${sticker.club}</strong></div>
                                    <div style="font-size: 0.8em; color: #666;">${new Date(sticker.timestamp).toLocaleString()}</div>
                                </div>
                            `);
                    } catch (error) {
                        console.error('Erreur lors du chargement du sticker:', error);
                    }
                });
            }

            // Page 2 - Photo
            resetPhotoPage() {
                document.getElementById('cameraPlaceholder').style.display = 'flex';
                document.getElementById('videoPreview').style.display = 'none';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('takePictureBtn').style.display = 'block';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('retakeBtn').style.display = 'none';
                document.getElementById('continueBtn').style.display = 'none';
                this.capturedImage = null;
                
                // Reset file input
                document.getElementById('fileInput').value = '';
            }

            async startCamera() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    
                    const video = document.getElementById('videoPreview');
                    video.srcObject = this.stream;
                    
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    video.style.display = 'block';
                    document.getElementById('takePictureBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'block';
                    document.getElementById('retakeBtn').style.display = 'block';
                    
                } catch (err) {
                    console.error('Erreur cam√©ra:', err);
                    this.showNotification('Impossible d\'acc√©der √† la cam√©ra', 'error');
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
            }

            capturePhoto() {
                const video = document.getElementById('videoPreview');
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                this.capturedImage = canvas.toDataURL('image/jpeg', 0.8);
                this.displayCapturedImage();
            }

            displayCapturedImage() {
                const img = document.getElementById('imagePreview');
                img.src = this.capturedImage;
                img.style.display = 'block';
                
                document.getElementById('videoPreview').style.display = 'none';
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('cameraPlaceholder').style.display = 'none';
                
                this.stopCamera();
                
                // Auto-passage √† la page 3 apr√®s 1 seconde
                setTimeout(() => {
                    this.showPage(3);
                }, 1000);
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                // V√©rifier que c'est bien une image
                if (!file.type.startsWith('image/')) {
                    this.showNotification('Veuillez s√©lectionner une image valide', 'error');
                    return;
                }

                // V√©rifier la taille du fichier (limite √† 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    this.showNotification('Image trop volumineuse (max 5MB)', 'error');
                    return;
                }

                // Redimensionner l'image avant de l'utiliser
                this.resizeImage(file, (resizedImage) => {
                    this.capturedImage = resizedImage;
                    
                    // Afficher l'image s√©lectionn√©e
                    const img = document.getElementById('imagePreview');
                    img.src = this.capturedImage;
                    img.style.display = 'block';
                    
                    // Masquer les autres √©l√©ments
                    document.getElementById('cameraPlaceholder').style.display = 'none';
                    document.getElementById('videoPreview').style.display = 'none';
                    document.getElementById('takePictureBtn').style.display = 'none';
                    document.getElementById('captureBtn').style.display = 'none';
                    
                    // Afficher les boutons appropri√©s
                    document.getElementById('retakeBtn').style.display = 'block';
                    document.getElementById('continueBtn').style.display = 'block';
                    
                    this.showNotification('Image redimensionn√©e et pr√™te !', 'success');
                });
            }

            // Nouvelle m√©thode pour redimensionner les images
            resizeImage(file, callback) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // D√©finir la taille maximale (800x800 pixels)
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;
                    
                    let { width, height } = img;
                    
                    // Calculer les nouvelles dimensions en gardant le ratio
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = (height * MAX_WIDTH) / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = (width * MAX_HEIGHT) / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    // Redimensionner le canvas
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Dessiner l'image redimensionn√©e
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convertir en base64 avec compression
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(resizedDataUrl);
                };
                
                img.onerror = () => {
                    this.showNotification('Erreur lors du traitement de l\'image', 'error');
                };
                
                // Charger l'image
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // Page 3 - Confirmation
            setupConfirmationPage() {
                if (this.capturedImage) {
                    document.getElementById('finalImage').src = this.capturedImage;
                }

                // Remplir l'heure actuelle
                document.getElementById('timeInput').value = new Date().toLocaleString('fr-FR');

                // Remplir les coordonn√©es
                if (this.selectedCoords) {
                    document.getElementById('locationInput').value = 
                        `${this.selectedCoords.lat.toFixed(6)}, ${this.selectedCoords.lng.toFixed(6)}`;
                }
                
                // Reset du formulaire
                document.getElementById('clubInput').value = '';
            }

            saveSticker() {
                const club = document.getElementById('clubInput').value;
                if (!club) {
                    this.showNotification('Veuillez s√©lectionner un club', 'error');
                    return;
                }

                if (!this.capturedImage) {
                    this.showNotification('Aucune image s√©lectionn√©e', 'error');
                    return;
                }

                if (!this.selectedCoords) {
                    this.showNotification('Aucune position s√©lectionn√©e', 'error');
                    return;
                }

                const sticker = {
                    id: Date.now(),
                    lat: this.selectedCoords.lat,
                    lng: this.selectedCoords.lng,
                    club: club,
                    image: this.capturedImage,
                    timestamp: new Date().toISOString(),
                    location: document.getElementById('locationInput').value
                };

                this.stickers.push(sticker);
                
                // Sauvegarder avec gestion d'erreur
                if (this.saveStickersToStorage()) {
                    this.showNotification('Sticker enregistr√© avec succ√®s !', 'success');
                    
                    // Retour √† la carte avec rechargement
                    setTimeout(() => {
                        this.showPage(1);
                        this.loadNewSticker(sticker);
                        // Reset des donn√©es
                        this.selectedCoords = null;
                        this.capturedImage = null;
                    }, 1500);
                }
            }

            loadNewSticker(sticker) {
                try {
                    const marker = L.marker([sticker.lat, sticker.lng])
                        .addTo(this.map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <img src="${sticker.image}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;">
                                <div><strong>${sticker.club}</strong></div>
                                <div style="font-size: 0.8em; color: #666;">${new Date(sticker.timestamp).toLocaleString()}</div>
                            </div>
                        `);
                    
                    // Centrer sur le nouveau sticker
                    this.map.setView([sticker.lat, sticker.lng], 15);
                    marker.openPopup();
                } catch (error) {
                    console.error('Erreur lors de l\'ajout du nouveau sticker:', error);
                }
            }

            deleteSticker() {
                this.showNotification('Sticker supprim√©', 'error');
                setTimeout(() => {
                    this.showPage(1);
                    // Reset des donn√©es
                    this.selectedCoords = null;
                    this.capturedImage = null;
                }, 1000);
            }

            // Utilitaires
            async requestPermissions() {
                try {
                    await navigator.mediaDevices.getUserMedia({ video: true });
                } catch (err) {
                    console.log('Permissions cam√©ra non accord√©es');
                }

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(() => {}, () => {});
                }
            }

            setupEventListeners() {
                // Page 2 - Photo
                document.getElementById('takePictureBtn').addEventListener('click', () => {
                    this.startCamera();
                });

                document.getElementById('captureBtn').addEventListener('click', () => {
                    this.capturePhoto();
                });

                document.getElementById('retakeBtn').addEventListener('click', () => {
                    this.resetPhotoPage();
                });

                document.getElementById('fileInput').addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });

                // AJOUT : Event listener pour le bouton "Continuer" 
                document.getElementById('continueBtn').addEventListener('click', () => {
                    if (this.capturedImage) {
                        this.showPage(3);
                    } else {
                        this.showNotification('Aucune image s√©lectionn√©e', 'error');
                    }
                });

                // Page 3 - Confirmation
                document.getElementById('saveBtn').addEventListener('click', () => {
                    this.saveSticker();
                });

                document.getElementById('deleteBtn').addEventListener('click', () => {
                    this.deleteSticker();
                });
            }

            showNotification(message, type) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', () => {
            new StickerApp();
        });
    </script>
</body>
</html>
